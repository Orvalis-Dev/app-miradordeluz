---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import { WhatsAppButton } from '../components/common/WhatsAppButton';
import { IconWhatsApp } from '../components/common/Icons';

// FontSource Imports
import '@fontsource/montserrat/300.css';
import '@fontsource/montserrat/400.css';
import '@fontsource/montserrat/500.css';
import '@fontsource/montserrat/600.css';
import '@fontsource/montserrat/700.css';
import '@fontsource/montserrat/800.css';
import '@fontsource/merriweather/400.css';
import '@fontsource/merriweather/700.css';
import '@fontsource/merriweather/900.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
  noIndex?: boolean; // Opción para ocultar páginas que no quieras indexar (ej: gracias por su compra)
}

const { 
  title, 
  // Descripción por defecto optimizada si no pasas una específica
  description = 'La combinación perfecta: la energía de la ciudad y el silencio de la montaña. Relajate en nuestras cabañas totalmente equipadas con piscina y vistas panorámicas, a solo 10 minutos del centro de Carlos Paz. Cerca de todo, lejos del ruido.',
  image = '/og-image.jpg',
  noIndex = false
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
// Lógica mejorada: Si el título ya tiene la marca, no la repite.
const siteName = 'Mirador de Luz';
const fullTitle = title.includes(siteName) ? title : `${title} | ${siteName}`;

// Datos reales extraídos de tus imágenes para el Schema (Google Maps data)
const businessData = {
  name: "Complejo de Cabañas Mirador de Luz",
  address: "Las Orquideas 893, X5152 Villa Santa Cruz del Lago, Córdoba, Argentina",
  phone: "+543813513513",
  email: "miradordeluz2019@gmail.com",
  image: new URL(image, Astro.site).toString(),
  priceRange: "$$" 
};

// Schema.org JSON-LD para Hoteles/Alojamientos (CRUCIAL PARA SEO)
const schema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "LodgingBusiness",
  "name": businessData.name,
  "image": [businessData.image],
  "description": description,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Las Orquideas 893",
    "addressLocality": "Villa Santa Cruz del Lago",
    "addressRegion": "Córdoba",
    "postalCode": "X5152",
    "addressCountry": "AR"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": -31.3995, // APROXIMADO: Verifica esto en Google Maps con tu pin exacto
    "longitude": -64.5020 // APROXIMADO: Verifica esto en Google Maps
  },
  "telephone": businessData.phone,
  "email": businessData.email,
  "url": Astro.site,
  "starRating": {
    "@type": "Rating",
    "ratingValue": "5" // Basado en tus reviews de Google
  },
  "amenityFeature": [
    { "@type": "LocationFeatureSpecification", "name": "Piscina", "value": "True" },
    { "@type": "LocationFeatureSpecification", "name": "WiFi", "value": "True" },
    { "@type": "LocationFeatureSpecification", "name": "Estacionamiento", "value": "True" },
    { "@type": "LocationFeatureSpecification", "name": "Vista a la montaña", "value": "True" }
  ]
});
---

<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8" />
  
  <!-- Google Tag Manager -->
  <script is:inline>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W43G6S3D');
  </script>
  <!-- End Google Tag Manager -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="generator" content={Astro.generator} />
  
  <title>{fullTitle}</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={canonicalURL} />
  <meta name="theme-color" content="#FF8C00" /> {noIndex ? <meta name="robots" content="noindex, nofollow" /> : <meta name="robots" content="index, follow" />}

  <meta name="geo.region" content="AR-X" />
  <meta name="geo.placename" content="Villa Santa Cruz del Lago" />
  <meta name="geo.position" content="-31.3995;-64.5020" /> <meta name="ICBM" content="-31.3995, -64.5020" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={fullTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={new URL(image, Astro.site)} />
  <meta property="og:site_name" content={siteName} />
  <meta property="og:locale" content="es_AR" />
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalURL} />
  <meta name="twitter:title" content={fullTitle} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={new URL(image, Astro.site)} />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  
  <script type="application/ld+json" set:html={schema} />

  <link rel="sitemap" href="/sitemap-index.xml" />
  <ViewTransitions />
</head>
<body class="min-h-screen flex flex-col bg-gray-50 text-gray-900 selection:bg-orange-500 selection:text-white">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W43G6S3D"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <slot />

  <WhatsAppButton 
    client:load 
    className="fixed bottom-6 right-6 z-50 p-4 bg-[#25D366] text-white rounded-full shadow-2xl hover:bg-[#128C7E] transition-all hover:scale-110 flex items-center justify-center group"
    aria-label="Contactar por WhatsApp"
  >
    <IconWhatsApp className="w-8 h-8" />
  </WhatsAppButton>

  <script>
    /**
     * Mejora del scroll para sitios con animaciones GSAP y expansiones de layout.
     * Desactiva la restauración automática del navegador para evitar saltos.
     */
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    const scrollToHash = () => {
      const hash = window.location.hash;

      // Si no hay hash, forzamos el inicio en la parte superior (Hero)
      if (!hash) {
        window.scrollTo(0, 0);
        return;
      }

      const targetId = hash.substring(1);
      const targetElement = document.getElementById(targetId);

      if (targetElement) {
        // 1. Intento casi inmediato (fuerza la carga de la zona)
        setTimeout(() => {
          targetElement.scrollIntoView({ behavior: 'auto', block: 'start' });
        }, 100);

        // 2. Segundo intento a los 500ms (cuando React/Hydration suele haber terminado)
        setTimeout(() => {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 500);

        // 3. Intento final definitivo a los 1500ms 
        // (después de animaciones de expansión de 1s y cálculos de GSAP)
        setTimeout(() => {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 1500);
      }
    };

    // Ejecutar al cargar la página (inicial y transiciones)
    document.addEventListener('astro:page-load', scrollToHash);
    
    // Si el usuario hace clic en un link con hash estando en la misma página
    window.addEventListener('hashchange', scrollToHash);
  </script>
</body>
</html>

