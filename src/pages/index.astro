---
import Layout from "../layouts/Layout.astro";
import NavbarMiradorDeLuz from "../components/react/NavbarMiradorDeLuz";
import HeroMiradorDeLuz from "../components/react/HeroMiradorDeLuz";
import SectionUbicacionMiradorDeLuz from "../components/react/SectionUbicacionMiradorDeLuz";
import SectionHeroIntermedio from "../components/react/SectionHeroIntermedio";
import SectionCabanas from "../components/react/SectionCabanas";
import SectionServicios from "../components/react/SectionServicios";
import SectionTestimonios from "../components/react/SectionTestimonios";
import FooterMiradorDeLuz from "../components/react/FooterMiradorDeLuz";
import ScrollAnimations from "../components/react/ScrollAnimations";
import { fetchGoogleReviews, fetchReviewsByPlaceName, type GoogleReview } from "../utils/googlePlaces";
import { SITE_CONFIG } from "../constants/config";

// Obtener reseñas de Google Places en build time
let googleReviews: GoogleReview[] = [];
const apiKey = import.meta.env.PRIVATE_GOOGLE_PLACES_API_KEY;
const placeIdEnv = import.meta.env.PRIVATE_GOOGLE_PLACE_ID;

if (apiKey) {
  try {
    if (placeIdEnv) {
      // Si tenemos el Place ID configurado, usarlo directamente
      googleReviews = await fetchGoogleReviews(apiKey, placeIdEnv, 5);
      console.log(`[Google Places] Se obtuvieron ${googleReviews.length} reseñas usando Place ID configurado`);
    } else {
      // Si no tenemos el Place ID, buscarlo por nombre y coordenadas
      const { placeName, coordinates } = SITE_CONFIG.googleMaps;
      const result = await fetchReviewsByPlaceName(
        apiKey,
        placeName,
        coordinates.lat,
        coordinates.lng,
        5
      );
      
      if (result) {
        googleReviews = result.reviews;
        console.log(`[Google Places] Se obtuvieron ${googleReviews.length} reseñas buscando por nombre`);
        console.log(`[Google Places] Place ID encontrado: ${result.placeId}`);
      }
    }
  } catch (error) {
    console.error('[Google Places] Error al obtener reseñas:', error);
  }
} else {
  console.warn('[Google Places] API Key no configurada. Se usarán testimonios de fallback.');
}

// Transformar las reseñas al formato del componente de testimonios
const testimoniosGoogle = googleReviews.map((review) => ({
  id: review.id,
  name: review.name,
  subtitle: review.subtitle || 'Google Maps',
  text: review.text,
  rating: review.rating,
  avatarUrl: review.avatarUrl,
}));

// URL para dejar una reseña
const googleReviewUrl = SITE_CONFIG.googleMaps.reviewUrl;
---

<Layout title="Mirador de Luz - Cabañas en Carlos Paz">
  <!-- Navbar fijo que permanece visible durante el scroll -->
  <NavbarMiradorDeLuz client:load />

  <ScrollAnimations client:load />

  <main>
    <!-- 1. Hero Principal -->
    <div id="hero-section" style="position: relative;">
      <HeroMiradorDeLuz client:load />
      <div
        class="hero-overlay"
        style="position: absolute; inset: 0; background: black; opacity: 0.5; pointer-events: none; z-index: 5;"
      >
      </div>
    </div>

    <!-- 2. Ubicación Section -->
    <div
      id="ubicacion"
      class="scroll-mt-20"
      style="position: relative; z-index: 10; background: white;"
    >
      <SectionUbicacionMiradorDeLuz client:visible />
    </div>

    <!-- 3. Hero Intermedio con Video (60% → 100% con animación) -->
    <div id="hero-intermedio-section" style="position: relative; z-index: 9;">
      <SectionHeroIntermedio
        client:visible
        videoMobile="/videos/video-mobile.mp4"
        videoDesktop="/videos/video-desktop.mp4"
        subheading="MIRADOR DE LUZ"
        title="Experiencia única.\nEntre las montañas."
        overlayOpacity="dark"
        hideNavbar={false}
      />
    </div>

    <!-- 4. Cabañas Section -->
    <div
      id="cabanas-section"
      style="position: relative; z-index: 11; background: white;"
    >
      <div id="cabanas" class="scroll-mt-20">
        <SectionCabanas client:visible />
      </div>
    </div>

    <!-- 5. Servicios e Instalaciones Section -->
    <div id="servicios" class="scroll-mt-20">
      <SectionServicios client:visible />
    </div>

    <!-- 6. Testimonios Section - Integrado con Google Maps -->
    <div id="testimonios" class="scroll-mt-20">
      <SectionTestimonios 
        client:visible 
        textoBoton="Ver todas las opiniones en Google Maps"
        googleReviewUrl={googleReviewUrl}
      />
    </div>
  </main>

  <!-- Footer -->
  <FooterMiradorDeLuz client:load />
</Layout>
